<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Stop Manager</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --primary: #e74c3c; --bg: #f8f9fa; --text: #202124; }

        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Google Sans', sans-serif; background: var(--bg); }

        /* LEFT PANEL: FORM */
        .sidebar { width: 350px; background: white; padding: 25px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; overflow-y: auto; display: flex; flex-direction: column; }

        h2 { color: var(--text); display: flex; align-items: center; gap: 10px; margin-top: 0; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 500; color: #5f6368; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; font-family: inherit; box-sizing: border-box; transition: 0.2s; }
        input:focus { border-color: var(--primary); outline: none; }

        .row { display: flex; gap: 10px; }

        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 10px; font-size: 1rem; box-shadow: 0 4px 6px rgba(231, 76, 60, 0.3); transition: transform 0.1s; }
        button:active { transform: scale(0.98); }

        #status { margin-top: 15px; text-align: center; font-size: 0.9rem; }

        /* RIGHT PANEL: MAP */
        #map { flex-grow: 1; height: 100%; cursor: crosshair; }

        .instruction { background: #e8f0fe; color: #1967d2; padding: 10px; border-radius: 6px; font-size: 0.85rem; margin-bottom: 20px; border-left: 4px solid #1967d2; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2><i class="fa-solid fa-map-pin" style="color: var(--primary);"></i> Add Stop</h2>

        <div class="instruction">
            <i class="fa-solid fa-info-circle"></i> <b>Tip:</b> Click anywhere on the map to auto-fill Latitude & Longitude.
        </div>

        <div class="form-group">
            <label>Stop Name</label>
            <input type="text" id="name" placeholder="e.g. Bus Stand Majholi">
        </div>

        <div class="form-group">
            <label>Route Code (Optional)</label>
            <input type="text" id="routeCode" placeholder="e.g. R-101" onblur="loadExistingStops()">
        </div>

        <div class="form-group">
            <label>Sequence No.</label>
            <input type="number" id="sequence" placeholder="e.g. 1, 2, 3...">
        </div>

        <div class="row">
            <div class="form-group">
                <label>Latitude</label>
                <input type="text" id="lat" placeholder="23.xxxx">
            </div>
            <div class="form-group">
                <label>Longitude</label>
                <input type="text" id="lon" placeholder="79.xxxx">
            </div>
        </div>

        <button onclick="saveStop()">ADD STOP</button>
        <div id="status"></div>

        <div style="margin-top: auto; font-size: 0.8rem; color: #888; text-align: center;">
            Existing Stops: <span id="stopCount">0</span>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_BASE = "http://localhost:5000"; // Update if using Ngrok

        // 1. Initialize Map (Centered on Majholi/Jabalpur area)
        const map = L.map('map').setView([23.4938, 79.9184], 13);

        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        let tempMarker = null;
        let existingMarkers = L.layerGroup().addTo(map);

        // 2. Handle Map Click
        map.on('click', function(e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);

            // Update Inputs
            document.getElementById('lat').value = lat;
            document.getElementById('lon').value = lng;

            // Show Temp Marker (Red)
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'new-stop-marker',
                    html: '<div style="background:red; width:14px; height:14px; border:2px solid white; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.4);"></div>',
                    iconSize: [14, 14]
                })
            }).addTo(map).bindPopup("New Location Selected").openPopup();
        });

        // 3. Save Function
        async function saveStop() {
            const btn = document.querySelector('button');
            const status = document.getElementById('status');

            const payload = {
                name: document.getElementById('name').value,
                routeCode: document.getElementById('routeCode').value,
                sequence: document.getElementById('sequence').value,
                lat: document.getElementById('lat').value,
                lon: document.getElementById('lon').value
            };

            if(!payload.name || !payload.lat || !payload.lon) {
                alert("Please fill Name and select a location on Map!");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                const res = await fetch(`${API_BASE}/stops`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if(json.success) {
                    status.innerHTML = `<span style="color:green">✅ Stop Added: <b>${payload.name}</b></span>`;

                    // Reset Form for next entry
                    document.getElementById('name').value = "";
                    document.getElementById('sequence').value = parseInt(payload.sequence || 0) + 1; // Auto increment sequence

                    // Refresh Map
                    loadExistingStops();
                } else {
                    status.innerHTML = `<span style="color:red">❌ Error: ${json.error}</span>`;
                }
            } catch(e) {
                console.error(e);
                status.innerHTML = `<span style="color:red">Network Error</span>`;
            }
            btn.disabled = false;
            btn.innerText = "ADD STOP";
        }

        // 4. Load Existing Stops (Blue Dots)
        async function loadExistingStops() {
            const routeCode = document.getElementById('routeCode').value;
            let url = `${API_BASE}/stops`;

            // If route code is entered, filter by it
            if(routeCode) url = `${API_BASE}/routes/${routeCode}/stops`;

            try {
                const res = await fetch(url);
                const json = await res.json();

                existingMarkers.clearLayers();
                document.getElementById('stopCount').innerText = json.stops.length;

                json.stops.forEach(s => {
                    L.circleMarker([s.lat, s.lon], {
                        radius: 6,
                        fillColor: "#3498db",
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 1
                    }).addTo(existingMarkers)
                    .bindTooltip(`${s.sequence || '#'}. ${s.name}`, {permanent: false, direction: 'top'});
                });
            } catch(e) { console.log("Error loading stops"); }
        }

        // Load all stops initially
        loadExistingStops();
    </script>
</body>
</html>
