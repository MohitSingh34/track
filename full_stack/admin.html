<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>BusMitra Admin - Route & Stop Manager</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 350px; padding: 20px; background: #f8f9fa; border-right: 1px solid #ddd; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .map { flex: 1; cursor: crosshair; }

        h2 { margin-top: 0; color: #2c3e50; }
        .section { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        label { font-weight: bold; font-size: 0.9rem; display: block; margin-bottom: 5px; margin-top: 10px; }
        input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 15px; transition: 0.2s; }

        .btn-blue { background: #3498db; color: white; }
        .btn-green { background: #2ecc71; color: white; }
        button:hover { opacity: 0.9; }

        .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #ddd; border-radius: 4px; }
        .tab.active { background: #2c3e50; color: white; }

        #zoomLevel { font-size: 0.8em; color: #666; text-align: right; margin-top: 5px; }
        .coord-display { background: #eee; color: #555; font-family: monospace; font-size: 0.8rem; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>üõ†Ô∏è Map Manager</h2>

        <div class="tabs">
            <div class="tab active" onclick="switchMode('route')">Routes</div>
            <div class="tab" onclick="switchMode('stop')">Stops</div>
        </div>

        <div id="routeSection" class="section">
            <h3>üìç Generate Route</h3>
            <label>Name:</label> <input id="rName" placeholder="Majholi to Sihora">
            <label>Code:</label> <input id="rCode" placeholder="MJH-01">
            <label>Color:</label> <input type="color" id="rColor" value="#1a73e8" style="height:40px;">
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
            <label>Start Point:</label> <input id="start" class="coord-display" readonly placeholder="Click on map...">
            <label>End Point:</label> <input id="end" class="coord-display" readonly placeholder="Click on map...">

            <button class="btn-blue" onclick="previewRoute()">‚ö° Preview Path</button>
            <div id="routeStats" style="margin-top:10px; font-size: 0.9em; color:#666;"></div>
            <button class="btn-green" onclick="saveRoute()" id="btnSaveRoute" disabled>üíæ Save Route to DB</button>
        </div>

        <div id="stopSection" class="section" style="display:none;">
            <h3>üöè Add Bus Stop</h3>
            <label>Stop Name:</label>
            <input id="sName" placeholder="e.g. Indrana Square">

            <label>Route Code (Optional):</label>
            <input id="sRouteCode" placeholder="e.g. MJH-01 (Links to Route)">

            <label>Sequence No:</label>
            <input type="number" id="sSequence" placeholder="e.g. 1">

            <label>Location:</label>
            <input id="sLoc" class="coord-display" readonly placeholder="Click on map to set...">

            <button class="btn-green" onclick="saveStop()">üíæ Save Stop to DB</button>
            <div id="stopStatus" style="margin-top:10px; font-size: 0.9em;"></div>
        </div>

        <div id="zoomLevel">Zoom Level: 12</div>
    </div>

    <div id="map" class="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Set your backend URL here
        const API_BASE = "https://awhirl-digestibly-refugio.ngrok-free.dev";

        // Google Maps Tile Layer
        const googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });

        const map = L.map('map', { preferCanvas: true, zoomControl: false }).setView([23.4938, 79.9184], 13);
        googleStreets.addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);

        let mode = 'route';
        let clickStage = 0;
        let routeData = null;
        let tempMarker;

        // Layers
        let lineGroup = L.layerGroup().addTo(map);
        let dotsGroup = L.layerGroup().addTo(map);

        // Zoom Logic
        const ZOOM_THRESHOLD = 16;
        map.on('zoomend', () => {
            const z = map.getZoom();
            document.getElementById('zoomLevel').innerText = `Zoom Level: ${z} (${z >= ZOOM_THRESHOLD ? 'Dots Mode' : 'Line Mode'})`;
            updateLayerVisibility(z);
        });

        function updateLayerVisibility(zoom) {
            if (zoom >= ZOOM_THRESHOLD) {
                if (map.hasLayer(lineGroup)) map.removeLayer(lineGroup);
                if (!map.hasLayer(dotsGroup)) map.addLayer(dotsGroup);
            } else {
                if (map.hasLayer(dotsGroup)) map.removeLayer(dotsGroup);
                if (!map.hasLayer(lineGroup)) map.addLayer(lineGroup);
            }
        }

        function switchMode(newMode) {
            mode = newMode;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('routeSection').style.display = mode === 'route' ? 'block' : 'none';
            document.getElementById('stopSection').style.display = mode === 'stop' ? 'block' : 'none';
            if(tempMarker) map.removeLayer(tempMarker);
            clickStage = 0;
        }

        map.on('click', (e) => {
            const latlng = e.latlng;
            const coordStr = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;

            if (mode === 'stop') {
                if(tempMarker) map.removeLayer(tempMarker);
                // Google style marker for Stop
                tempMarker = L.marker(latlng, {draggable: true}).addTo(map);
                tempMarker.on('dragend', function(ev) {
                    const newPos = ev.target.getLatLng();
                    document.getElementById('sLoc').value = `${newPos.lat.toFixed(6)}, ${newPos.lng.toFixed(6)}`;
                });
                document.getElementById('sLoc').value = coordStr;
            }
            else if (mode === 'route') {
                const color = document.getElementById('rColor').value;
                if (clickStage === 0) {
                    document.getElementById('start').value = coordStr;
                    if(tempMarker) map.removeLayer(tempMarker);
                    tempMarker = L.circleMarker(latlng, {radius: 6, color: 'green', fillOpacity: 1}).addTo(map);
                    clickStage = 1;
                } else {
                    document.getElementById('end').value = coordStr;
                    clickStage = 0;
                    map.removeLayer(tempMarker);
                }
            }
        });

        function densifyPath(latlngs, spacingMeters) {
            let dense = [];
            for (let i = 0; i < latlngs.length - 1; i++) {
                let p1 = L.latLng(latlngs[i]);
                let p2 = L.latLng(latlngs[i+1]);
                let dist = p1.distanceTo(p2);
                dense.push(latlngs[i]);
                if (dist > spacingMeters) {
                    let steps = Math.floor(dist / spacingMeters);
                    for (let j = 1; j <= steps; j++) {
                        let fraction = j / (steps + 1);
                        let lat = p1.lat + (p2.lat - p1.lat) * fraction;
                        let lng = p1.lng + (p2.lng - p1.lng) * fraction;
                        dense.push([lat, lng]);
                    }
                }
            }
            dense.push(latlngs[latlngs.length - 1]);
            return dense;
        }

        async function previewRoute() {
            const s = document.getElementById('start').value.split(',');
            const e = document.getElementById('end').value.split(',');
            const color = document.getElementById('rColor').value;

            if(s.length < 2 || e.length < 2) return alert("Select Start and End points first!");

            // OSRM handles the path calculation
            const url = `https://router.project-osrm.org/route/v1/driving/${s[1].trim()},${s[0].trim()};${e[1].trim()},${e[0].trim()}?overview=full&geometries=geojson`;

            try {
                const res = await fetch(url);
                const json = await res.json();

                if(json.routes && json.routes[0]) {
                    const r = json.routes[0];
                    const rawLatLngs = r.geometry.coordinates.map(c => [c[1], c[0]]);

                    lineGroup.clearLayers();
                    dotsGroup.clearLayers();

                    // Dots View
                    const denseLatLngs = densifyPath(rawLatLngs, 20);
                    for (let i = 0; i < denseLatLngs.length; i++) {
                        L.circleMarker(denseLatLngs[i], {
                            radius: 2, color: color, opacity: 0.75, weight: 2, fill: false, interactive: false
                        }).addTo(dotsGroup);
                    }

                    // Line View
                    L.polyline(rawLatLngs, { color: color, weight: 8, opacity: 0.8, lineCap: 'round' }).addTo(lineGroup);
                    L.polyline(rawLatLngs, { color: '#ffffff', weight: 5, opacity: 0.7, lineCap: 'round' }).addTo(lineGroup);

                    const boundsLine = L.polyline(rawLatLngs, {opacity: 0}).addTo(map);
                    map.fitBounds(boundsLine.getBounds(), {padding: [50,50]});

                    updateLayerVisibility(map.getZoom());

                    routeData = {
                        name: document.getElementById('rName').value,
                        code: document.getElementById('rCode').value,
                        color: color,
                        coordinates: denseLatLngs,
                        distance: (r.distance/1000).toFixed(1) + " km",
                        duration: (r.duration/60).toFixed(0) + " min"
                    };
                    document.getElementById('routeStats').innerText = `‚úÖ Distance: ${routeData.distance}, Est. Time: ${routeData.duration}`;
                    document.getElementById('btnSaveRoute').disabled = false;
                }
            } catch(err) { console.error(err); alert("Error calculating route"); }
        }

        async function saveRoute() {
            if(!routeData) return;
            const btn = document.getElementById('btnSaveRoute');
            btn.innerText = "Saving...";

            try {
                await fetch(`${API_BASE}/routes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true' // Essential for ngrok
                    },
                    body: JSON.stringify(routeData)
                });
                alert("Route Saved Successfully!");
                location.reload();
            } catch (e) {
                alert("Failed to save route. Check console.");
                console.error(e);
            }
            btn.innerText = "üíæ Save Route";
        }

        async function saveStop() {
            const name = document.getElementById('sName').value;
            const loc = document.getElementById('sLoc').value;
            const rCode = document.getElementById('sRouteCode').value;
            const seq = document.getElementById('sSequence').value;
            const status = document.getElementById('stopStatus');

            if(!name || !loc) {
                alert("Stop Name and Location are required!");
                return;
            }

            const [lat, lon] = loc.split(',').map(s => s.trim());

            const payload = {
                name: name,
                lat: lat,
                lon: lon,
                routeCode: rCode || "",
                sequence: seq || 0
            };

            status.innerText = "Saving...";

            try {
                const res = await fetch(`${API_BASE}/stops`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if(json.success) {
                    status.innerHTML = `<span style="color:green">‚úÖ Saved: ${name}</span>`;
                    // Auto-increment sequence for convenience
                    if(seq) document.getElementById('sSequence').value = parseInt(seq) + 1;
                    document.getElementById('sName').value = "";
                    document.getElementById('sLoc').value = "";
                    if(tempMarker) map.removeLayer(tempMarker);
                } else {
                    status.innerHTML = `<span style="color:red">‚ùå Error: ${json.error}</span>`;
                }
            } catch(e) {
                console.error(e);
                status.innerHTML = `<span style="color:red">‚ùå Network Error</span>`;
            }
        }
    </script>
</body>
</html>
